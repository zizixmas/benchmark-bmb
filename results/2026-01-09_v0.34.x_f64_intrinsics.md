# BMB Benchmark Report - v0.34.x (f64 Intrinsics)

> Date: 2026-01-09
> BMB Version: v0.34.x (sqrt, i64_to_f64, f64_to_i64 intrinsics)
> Rust Version: 1.8x (native LLVM)
> System: Windows 11

## Executive Summary

| Achievement | Status |
|-------------|--------|
| f64 type support | ✅ Complete |
| sqrt intrinsic | ✅ Implemented (LLVM intrinsic) |
| i64_to_f64 conversion | ✅ Implemented (sitofp) |
| f64_to_i64 conversion | ✅ Implemented (fptosi) |
| LLVM IR generation | ✅ Fixed (double type, float ops) |
| Interpreter correctness | ✅ Verified |

---

## New Benchmarks Enabled

### 1. mandelbrot_fp (Floating-Point Mandelbrot)

**Source**: `ecosystem/benchmark-bmb/benches/compute/mandelbrot/bmb/main_fp.bmb`

| Metric | Value |
|--------|-------|
| Output | 3989 (matches Rust) |
| Lines of Code | 55 |
| f64 Operations | ✅ fmul, fdiv, fsub, fcmp |
| Conversion | ✅ i64_to_f64 |

**Performance** (Interpreter):
| Language | Time (ms) | Ratio |
|----------|-----------|-------|
| Rust (native) | ~56 | baseline |
| BMB (interpreter) | ~8200 | 146x slower |

*Note: Interpreter overhead is expected. Native compilation required for fair comparison.*

### 2. n_body (Simplified 2-Body Simulation)

**Source**: `ecosystem/benchmark-bmb/benches/compute/n_body/bmb/main.bmb`

| Metric | Value |
|--------|-------|
| Output | -142736398 (scaled energy) |
| Lines of Code | 111 |
| sqrt calls | ✅ Using `@llvm.sqrt.f64` |
| f64 Operations | ✅ Complete |

**Performance** (Interpreter):
| Language | Time (ms) | Ratio |
|----------|-----------|-------|
| Rust (5-body native) | ~43 | baseline |
| BMB (2-body interpreter) | ~270 | 6x slower |

*Note: BMB uses simplified 2-body simulation due to lack of arrays.*

---

## LLVM IR Generation Fixes

### Issue 1: Integer Operations for Float Types
- **Problem**: MIR used `Add/Sub/Mul/Div` instead of `FAdd/FSub/FMul/FDiv`
- **Fix**: Type-based override in `llvm_text.rs:816-844`
- **Result**: `fmul double` instead of `add nsw double`

### Issue 2: Wrong Type Name
- **Problem**: Output `f64` instead of `double`
- **Fix**: Updated `mir_type_to_llvm` and `infer_call_return_type`
- **Result**: LLVM-compatible type names

### Issue 3: Float Constant Format
- **Problem**: `4e0` instead of `4.000000e+00`
- **Fix**: Use `{:.6e}` format in `format_constant`
- **Result**: LLVM-compatible float literals

---

## Generated LLVM IR Examples

### sqrt Intrinsic Call
```llvm
declare double @llvm.sqrt.f64(double)

; Usage in n_body.ll
%_t8 = call double @llvm.sqrt.f64(double %_t7)
```

### i64_to_f64 Conversion
```llvm
; pixel_to_x function
%_t0 = sitofp i64 %px to double
%_t1 = fmul double %_t0, 4.000000e0
```

### Float Operations
```llvm
; iterate_fp function
%_t2 = fmul double %x, %x
%_t3 = fmul double %y, %y
%_t4 = fadd double %_t2, %_t3
%_t5 = fcmp ogt double %_t4, 4.000000e0
```

---

## Comparison with Previous Benchmarks

| Benchmark | Phase 34.4 | v0.34.x | Notes |
|-----------|------------|---------|-------|
| fibonacci | 0.93x | 0.93x | Unchanged |
| mandelbrot (fixed) | 0.93x | 0.93x | Unchanged |
| spectral_norm | 0.89x | 0.89x | Unchanged |
| **mandelbrot_fp** | N/A | NEW | Uses i64_to_f64 |
| **n_body** | Blocked | NEW | Uses sqrt |

---

## Remaining Work

### For Native Benchmark Comparison
1. Set up LLVM/clang with VS environment
2. Compile BMB LLVM IR to native executables
3. Run fair native vs native comparisons

### For Full n_body Parity
1. Implement BMB arrays/structs (Phase 34.2)
2. Port full 5-body simulation

### For Further f64 Benchmarks
- spectral_norm_fp: Needs f64 arrays
- fannkuch: Needs permutation arrays

---

## Files Modified

| File | Change |
|------|--------|
| `bmb/src/codegen/llvm_text.rs` | Float ops, type names, intrinsics |
| `ecosystem/.../mandelbrot/bmb/main_fp.bmb` | New benchmark |
| `ecosystem/.../n_body/bmb/main.bmb` | Updated with sqrt |

---

## Benchmark Commands

```bash
# Type check
bmb check ecosystem/benchmark-bmb/benches/compute/mandelbrot/bmb/main_fp.bmb
bmb check ecosystem/benchmark-bmb/benches/compute/n_body/bmb/main.bmb

# Run with interpreter
bmb run ecosystem/benchmark-bmb/benches/compute/mandelbrot/bmb/main_fp.bmb
bmb run ecosystem/benchmark-bmb/benches/compute/n_body/bmb/main.bmb

# Generate LLVM IR
bmb build main_fp.bmb --emit-ir -o mandelbrot_fp.ll
bmb build main.bmb --emit-ir -o n_body.ll
```

---

*Generated by BMB Benchmark Suite v0.34.x*
*f64 intrinsics: sqrt, i64_to_f64, f64_to_i64*
